!window.Raphael&&document.write('<script src="http://cdn.jsdelivr.net/raphael/2.1.0/raphael-min.js"></script>');var GadgetoidDots=function(e){function t(e,t){return{x:e,y:t}}function n(){R.score.results.toFront()}function r(e){var t=R.score.log.attr("text");R.score.log.attr({text:e+"\n"+z.you_scored+" "+R.score.total+"\n"+t})}function i(e){return"rgb("+e.join(",")+")"}function s(e,t){return"rgba("+e.join(",")+","+t+")"}function o(e,t){var n=[0,0,0];for(var r in e){n[r]=e[r];n[r]+=t;if(n[r]>255)n[r]=255}return"rgb("+n.join(",")+")"}function u(){R.state.drag_path.attr({drag_path:[R.state.origin.x,R.state.origin.y,R.state.waypoints,R.state.drag.x,R.state.drag.y]})}function a(){var e=U.colours[this.data("col")];this.animate({fill:i(e)},200)}function f(){var e=U.colours[this.data("col")];this.animate({fill:o(e,100)},200)}function l(e){x=e.data("pos").x;y=e.data("pos").y;R.map[x+":"+y]=e;e.data("ords").x=(e.data("pos").x+1)*(U.dot_radius*2+U.dot_spacing)-U.dot_radius;e.data("ords").y=(e.data("pos").y+1)*(U.dot_radius*2+U.dot_spacing)-U.dot_radius;e.stop().animate({cx:e.data("ords").x,cy:e.data("ords").y},e.data("delay"),"bounce")}function c(){R.state.paused=true}function h(){R.state.paused=false}function p(e){R.state.paused=true;clearInterval(R.score.timer);setTimeout(h,2e3);R.score.started=false;for(var t in R.state.waypoints){R.state.waypoints[t].attr({fill:i(U.colours[R.state.waypoints[t].data("col")])})}k();r(e);n()}function d(){if(R.state.paused)return;R.score.time_left-=1;R.score.time.attr({text:R.score.time_left});if(R.score.time_left<=0){p(z.time_up);R.events.timeout()}}function v(){var e=false;R.dots.forEach(function(t,n){var r=t.data("col");var i=g(t.data("pos"));while(element=i.pop()){if(element.data("col")==r){e=true;break}}});if(!e){p(z.no_moves_left);R.events.lose()}}function m(e,t){if(R.state.paused)return;if(!R.score.started){R.score.total=0;R.score.started=true;R.score.time_left=U.time;R.score.time.attr({text:R.score.time_left});R.score.timer=setInterval(d,1e3)}R.state.origin=this.data("ords");R.state.origin.dot=this.data("pos");R.state.waypoints.push(this);R.state.colour=this.data("col")}function g(e){var n=[];if(U.horizontal){n.push(t(e.x-1,e.y));n.push(t(e.x+1,e.y))}if(U.vertical){n.push(t(e.x,e.y-1));n.push(t(e.x,e.y+1))}if(U.diagonal){n.push(t(e.x-1,e.y-1));n.push(t(e.x-1,e.y+1));n.push(t(e.x+1,e.y-1));n.push(t(e.x+1,e.y+1))}var r=[];for(e in n){if((found_dot=S(n[e]))!=false&&R.state.waypoints.indexOf(found_dot)==-1){r.push(found_dot)}}return r}function b(e,n){if(R.state.paused)return;e+=R.state.origin.x;n+=R.state.origin.y;R.state.drag=t(e,n);var r=R.state.waypoints[R.state.waypoints.length-1];var i=r.data("pos");var s=g(i);while(element=s.pop()){if(element.data("col")==R.state.colour&&e>element.data("ords").x-U.dot_radius-U.dot_spacing/3&&e<element.data("ords").x+U.dot_radius+U.dot_spacing/3&&n>element.data("ords").y-U.dot_radius-U.dot_spacing/3&&n<element.data("ords").y+U.dot_radius+U.dot_spacing/3){element.attr({fill:o(U.colours[element.data("col")],70)});R.state.waypoints.push(element);for(var a in R.state.waypoints){R.state.waypoints[a].stop().animate({fill:o(U.colours[R.state.waypoints[a].data("col")],2*R.state.waypoints.length*R.state.waypoints.length)},0)}s=[];return true}}u()}function w(){if(R.state.paused)return;if(R.state.waypoints.length>1){for(var e in R.state.waypoints){R.score.stats.removed[R.state.waypoints[e].data("col")]+=1;R.state.waypoints[e].attr({fill:i(U.colours[R.state.waypoints[e].data("col")])});N(R.state.waypoints[e])}T();R.score.total+=R.state.waypoints.length*R.state.waypoints.length*R.state.waypoints.length;R.score.stats.total_moves+=1;R.score.display.attr({text:R.score.total});var t;if(R.state.dots_in_play<=0&&(R.mode=="puzzle"||R.mode=="elimination")){R.score.running_total+=R.score.total;R.score.display_total.attr({text:R.score.running_total});R.events.win();p(z.cleared);U.level++;if(U.level>=R.levels.length){U.level=0}return false}v()}R.events.move();k()}function E(e){var t=e;var n=-1;R.dots.forEach(function(e,r){if(e==t){n=r}});return n}function S(e){var t=false;t=R.map[e.x+":"+e.y];if(typeof t=="object"&&t!==null){return t}else{return false}}function T(){while((x=R.state.columns_to_update.pop())!=null){var e=false;for(y=U.dots.y-2;y>=0;y--){var n=S(t(x,y));if(n!=false){var r=S(t(x,y+1));if(r==false){pos=n.data("pos");R.map[pos.x+":"+pos.y]=null;n.data("pos").y+=1;n.data({delay:1e3});l(n);e=true}}}if(U.respawn){if((n=R.pending[x].pop())!=null){n.data("pos").y=0;n.data({delay:1e3});var s=C(R.eliminate);n.attr({fill:i(U.colours[s])});n.data({col:s});l(n);R.state.dots_in_play++;e=true}}if(e)R.state.columns_to_update.push(x)}}function N(e){x=e.data("pos").x;y=e.data("pos").y;R.map[x+":"+y]=null;R.state.dots_in_play--;R.colour_count[e.data("col")]-=1;R.pending[x].push(e);e.data("pos").y=-1;e.data("ords").y=R.state.dot_start_y;if(R.state.columns_to_update.indexOf(e.data("pos").x)==-1){R.state.columns_to_update.push(e.data("pos").x)}e.attr({cy:R.state.dot_start_y})}function C(e){var t=-1;var n=U.colours.length*2,r=0;while(t=-1&&r<n){var i=Math.floor(Math.random()*U.colours.length);if(R.colour_count[i]>0||e==false){R.colour_count[i]+=1;t=i;return t}r++}return C(false)}function k(){R.state.waypoints=[];R.state.origin=t(0,0);R.state.origin.dot=t(0,0);R.state.drag=t(0,0);R.state.colour=-1;u()}function L(){R.state.dots_in_play=0;k();for(var e=0;e<U.colours.length;e++){R.colour_count[e]=0;R.score.stats.removed[e]=0}R.dots.forEach(function(e,t){r=e.data("pos").x;s=e.data("pos").y;R.map[r+":"+s]=null;R.pending[r].push(e);e.data("pos").y=-1;e.data("ords").y=R.state.dot_start_y-10;e.attr({cy:R.state.dot_start_y-10})});var n=0;for(var r=0;r<U.dots.x;r++){for(var s=0;s<U.dots.y;s++){dot=R.pending[r].pop();dot_x=r*(U.dot_radius*2+U.dot_spacing)+U.dot_spacing+U.dot_radius;dot_y=s*(U.dot_radius*2+U.dot_spacing)+U.dot_spacing+U.dot_radius;var o=C(false);if(U.use_levels){o=R.levels[U.level].pieces[s][r]-1;if(o==-1){continue}}dot.data({col:o,pos:t(r,s),ords:t(dot_x,dot_y),delay:0}).attr({fill:i(U.colours[o]),cx:dot_x,cy:R.state.dot_start_y});dot.animate({cy:R.state.dot_start_y},U.initial_delay-(n+r),function(){dot_y=this.data("ords").y;this.animate({cy:dot_y},1e3,"bounce")});R.map[r+":"+s]=dot;R.state.dots_in_play++;n+=R.state.in_delay}}}function A(){R.state.started=false;if(R.paper)R.paper.clear();U.colours=D;U.background=P;U.path=H;U.text=B;R.score=F;R.state=j;R.map=[];R.pending=[];R.colour_count=[];R.levels=[]}function O(){if(R.state.paused||R.blocked)return;R.score.log.attr({text:"","font-size":16});R.score.results.toBack();R.score.time.attr({text:"0"});R.score.display.attr({text:"0"});L()}function M(){if(R.state.started)return false;R.state.started=true;if(!document.getElementById(U.canvas)){document.write('<div id="'+U.canvas+'"></div>')}else{R.paper.clear()}Raphael.fn.roundedRectangle=function(e,t,n,r,i,s,o,u){var a=[];a=a.concat(["M",e,i+t,"Q",e,t,e+i,t]);a=a.concat(["L",e+n-s,t,"Q",e+n,t,e+n,t+s]);a=a.concat(["L",e+n,t+r-o,"Q",e+n,t+r,e+n-o,t+r]);a=a.concat(["L",e+u,t+r,"Q",e,t+r,e,t+r-u,"Z"]);return this.path(a)};R.state.dot_start_y=-U.dot_radius-U.dot_spacing;R.state.in_delay=U.initial_delay/U.dots.y/U.dots.x;var e=U.dot_radius+U.dot_spacing+5;game_width=U.dots.x*U.dot_radius*2+U.dot_spacing*(U.dots.x+1);game_height=U.dots.y*U.dot_radius*2+U.dot_spacing*(U.dots.y+1);R.paper=Raphael(document.getElementById(U.canvas),game_width,game_height+50);R.paper.text(0,game_height+20,z.score).attr({"text-anchor":"start","font-size":16});R.paper.text(0,game_height+40,z.total).attr({"text-anchor":"start","font-size":16});R.score.display=R.paper.text(60,game_height+20,"0").attr({"text-anchor":"start","font-size":16});R.score.display_total=R.paper.text(60,game_height+40,"0").attr({"text-anchor":"start","font-size":16});R.score.time=R.paper.text(game_width,game_height+20,"0").attr({"text-anchor":"end","font-size":16});R.paper.customAttributes.arc=function(e,t,n,r,i){var s=360/r*n,o=(90-s)*Math.PI/180,u=e+i*Math.cos(o),a=t-i*Math.sin(o),f;if(r==n){f=[["M",e,t-i],["A",i,i,0,1,1,e-.01,t-i]]}else{f=[["M",e,t-i],["A",i,i,0,+(s>180),1,u,a]]}return{path:f}};R.paper.customAttributes.drag_path=function(e,t,n,r,i){if(n.length>0){player_path=[];player_path.push(["m",n[0].data("ords").x,n[0].data("ords").y]);for(var s=1;s<n.length;s++){player_path.push([n[s].data("ords").x,n[s].data("ords").y])}player_path.push([r,i]);return{path:player_path}}else{return{path:[["m",0,0],[0,0]]}}};game_bg=R.paper.roundedRectangle(0,0,game_width,game_height,e,e,e,e);game_bg.attr({fill:i(U.background),stroke:"none"});R.paper.setStart();for(var n=0;n<U.dots.x;n++){R.pending[n]=[];for(var r=0;r<U.dots.y;r++){R.paper.circle(0,R.state.dot_start_y,U.dot_radius).attr({fill:"#FFFFFF",stroke:"transparent","stroke-width":U.dot_spacing}).data({col:-1,pos:t(n,r),ords:t(0,R.state.dot_start_y),delay:0})}}R.dots=R.paper.setFinish();var o=U.dot_spacing+U.dot_radius;R.paper.setStart();R.score.score_results_bg=R.paper.roundedRectangle(0,0,game_width,game_height,e,e,e,e);R.score.score_results_bg.attr({fill:s(U.background,.8),stroke:"none"});R.score.log=R.paper.text(o,game_height/2).attr({"text-anchor":"start",fill:i(U.text),"font-size":12});if(R.mode=="puzzle"){R.score.log.attr({text:"Hello, you have "+U.time+" seconds"+"\n"+"to clear the screen of dots."+"\n \n"+"Swipe across dots of the same colour"+"\n"+"to remove them from play."+"\n \n"+"Click to get started!"+"\n \n \n "+"pi.gadgetoid.com"})}else{R.score.log.attr({text:"Hello, you have "+U.time+" seconds"+"\n"+"to clear as many dots as possible."+"\n \n"+"Swipe across dots of the same colour"+"\n"+"to remove them from play."+"\n \n"+"Click to get started!"+"\n \n \n "+"pi.gadgetoid.com"})}R.score.results=R.paper.setFinish();R.score.results.click(function(){O()});R.score.results.drag(function(){},function(){O()},function(){});game_bg.drag(function(){},function(){},function(){});R.dots.drag(b,m,w);R.state.drag_cursor=R.paper.path().attr({stroke:i(U.path),"stroke-width":3});R.state.drag_path=R.paper.path().attr({stroke:i(U.path),"stroke-width":3});L()}function _(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}var D=[[42,161,152],[220,50,47],[211,54,130],[108,113,196],[133,153,0]];var P=[7,54,66];var H=[236,240,241];var B=[255,255,255];var j={started:false,origin:{x:0,y:0},waypoints:[],columns_to_update:[],paused:false,dots_in_play:0};var F={display:null,display_total:null,total:0,running_total:0,time_left:0,running:false,stats:{total_moves:0,removed:[]}};var I={canvas:e,dots:{x:7,y:7},dot_radius:8,dot_spacing:20,initial_delay:1e3,background:P,colours:D,path:H,text:B,time:90,diagonal:false,horizontal:true,vertical:true,eliminate:false,respawn:true,use_levels:false,level:0};var q={win:function(){},lose:function(){},move:function(){},timeout:function(){}};var R={mode:"default",map:[],pending:[],colour_count:[],score:F,state:j,levels:[],events:q};var U=I;var z={score:"score:",total:"total:",cleared:"Cleared!",no_moves_left:"No moves left!",time_up:"Time up!",you_scored:"You scored:"};return{on_move:function(e){R.events.move=e;return this},on_win:function(e){R.events.win=e;return this},on_lose:function(e){R.events.lose=e;return this},on_timeout:function(e){R.events.timeout=e;return this},set_dot_cols:function(e){if(R.state.started)return this;for(var t in e){if(e[t].length!=3&&e[t].indexOf("#")>-1){e[t]=_(e[t]);e[t]=[e[t].r,e[t].g,e[t].b]}}U.colours=e;return this},add_level:function(e,t){R.levels.push({title:e,pieces:t});return this},set_mode:function(e){R.mode=e;switch(e){case"puzzle":U.use_levels=true;U.elimination=false;U.respawn=false;break;case"elimination":U.use_levels=false;U.elimination=true;U.respawn=true;break;default:U.use_levels=false;U.elimination=false;break}return this},set_bg_col:function(e){e=_(e);U.background=[e.r,e.g,e.b];return this},set_text_col:function(e){e=_(e);U.text=[e.r,e.g,e.b];return this},set_path_col:function(e){e=_(e);U.path=[e.r,e.g,e.b];return this},set_dot_size:function(e,t){if(R.state.started)return this;U.dot_radius=e;U.dot_spacing=t;return this},set_timeout:function(e){U.time=e;return this},set_game_size:function(e,t){U.dots.x=e;U.dots.y=t;return this},set_allowed_moves:function(e,t,n){U.diagonal=n;U.horizontal=e;U.vertical=t;return this},pause:function(){c();return this},unpause:function(){h();return this},restart:function(){L();return this},begin:function(){O();return this},setup:function(){M();return this},clear:function(){A();return this},end:function(e){p(e);return this},get_state:function(){return R}}}